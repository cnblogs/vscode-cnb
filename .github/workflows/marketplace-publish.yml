# This workflow will do a clean install of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Publish extension to vscode extension marketplace

on:
    push:
        tags:
            - v*.*.*

env:
    GITLAB_NPM_TOKEN: ${{secrets.GITLAB_NPM_TOKEN}}

jobs:
    build:
        strategy:
            matrix:
                include:
                    - os: windows-latest
                      platform: win32
                      arch: x64
                      npm_config_arch: x64
                    - os: windows-latest
                      platform: win32
                      arch: ia32
                      npm_config_arch: ia32
                    - os: windows-latest
                      platform: win32
                      arch: arm64
                      npm_config_arch: arm
                    - os: ubuntu-latest
                      platform: linux
                      arch: x64
                      npm_config_arch: x64
                    - os: ubuntu-latest
                      platform: linux
                      arch: arm64
                      npm_config_arch: arm64
                    - os: ubuntu-latest
                      platform: linux
                      arch: armhf
                      npm_config_arch: arm
                    - os: ubuntu-latest
                      platform: alpine
                      arch: x64
                      npm_config_arch: x64
                    - os: macos-latest
                      platform: darwin
                      arch: x64
                      npm_config_arch: x64
                    - os: macos-latest
                      platform: darwin
                      arch: arm64
                      npm_config_arch: arm64
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v2

            - name: Use Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: 16.x
                  cache: 'npm'

            - name: 'Installing Dependencies'
              run: npm ci

            - name: 'Building'
              run: npm run package -- --env CLIENTID=${{ secrets.OAUTHCLIENTID }} --env CLIENTSECRET=${{ secrets.OAUTHCLIENTSECRET }} && npm run ui:package

            - name: 'Versioning'
              id: version
              shell: bash
              run: echo "VERSION=${{ github.ref_name }}" | sed 's/v//' >> $GITHUB_OUTPUT

            - id: targeting
              name: Targeting
              shell: pwsh
              run: echo "target=${{ matrix.platform }}-${{ matrix.arch }}" >> $env:GITHUB_OUTPUT

            - name: 'Packaging'
              run: npx vsce package --target ${{ steps.targeting.outputs.target }} --no-git-tag-version --no-update-package-json ${{ steps.version.outputs.VERSION }}

            - name: 'Uploading'
              uses: actions/upload-artifact@v2
              with:
                  name: ${{ steps.targeting.outputs.target }}
                  path: '*.vsix'

    publish:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - uses: actions/download-artifact@v2
            - run: npx vsce publish --packagePath $(find . -iname *.vsix) -p ${{ secrets.VSCETOKEN }}
